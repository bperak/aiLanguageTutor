## TASKS

### 2026-01-04
- ✅ POS categories for Lee/Matsushita (Neo4j resources): downloaded source sheets, extracted POS lists with English labels, and compared adjective handling. Matsushita POS obtained from `重要度順語彙リスト60894語` tab in XLSX.

### 2025-01-XX
- ✅ **Pre-lesson kits in profile building + fix session creation 500s**: Extended Build Your Learning Profile → Learning Path flow to include PreLessonKit (necessary words, grammar patterns, fixed phrases) for each CanDo step. Implemented hybrid prefetch strategy (first N steps during path generation, lazy for rest). Fixed production-breaking 500 errors on `/api/v1/cando/lessons/session/create` by using session service with automatic fallback to in-memory storage. Added comprehensive tests and frontend UI for displaying/generating kits.

### 2025-12-29
- Rethink Comprehension/Production/Interaction stage prompts in CanDo lesson generation and align Docker code-change persistence expectations.
- Add regression tests for CanDo prompt/repair to ensure JPText and enum guardrails (AIComprehensionTutor, ProductionExercises, InteractionActivities).

### 2025-12-15
- Improve production performance of `ailanguagetutor.syntagent.com` by ensuring the public deployment is not running Next.js dev mode (no HMR / dev-only endpoints).
- ✅ **Fix AI word content 401 + Neo4j stability/perf**: Fixed `/api/v1/ai-content/word/*` 401 in UI by attaching auth token; hardened `.env` loading across repo + Docker layouts; tuned Neo4j driver pooling/timeouts; updated tests + Playwright/MCP checks.

### 2025-12-17
- ✅ **CanDo lesson quality improvements**: Implemented quality gates for CanDo lesson generation with QualityReport/QualityIssue models, strengthened Stage1 prompts to enforce CanDo intent and measurable kit usage targets, added bounded repair loop for blocking issues in enforce mode, and exposed quality_mode/include_quality_report query flags on /lessons/start and /lessons/compile endpoints. Added comprehensive pytest tests for quality reporting and repair loop. Quality checks include kit coverage, prompt leak detection, topic mismatch detection, and structure validation.
- ✅ **CanDo 4-stage learning loop with progress tracking and adaptive recommendations**: Implemented complete 4-stage learning pattern (Content → Comprehension → Production → Interaction) for CanDo lessons. Backend: Added evidence recording endpoints (`POST /lessons/{can_do_id}/evidence/record`, `GET /lessons/{can_do_id}/evidence/summary`) that store per-stage evidence in `conversation_interactions` with `concept_type='cando_lesson'`. Added stage progress tracking methods in `cando_lesson_session_service.py` to store completion state in `lesson_sessions.stage_progress` JSONB. Created `cando_recommendation_service.py` to analyze evidence gaps and provide adaptive recommendations (next CanDo, review items, focus areas, common errors). Added endpoints: `GET /lessons/{can_do_id}/progress`, `POST /lessons/{can_do_id}/stages/{stage}/complete`, `GET /recommendations`. Created database migration for `stage_progress` column. Frontend: Added 4-stage UI tabs to CanDo lesson page (`/cando/[canDoId]/page.tsx`) with progress indicators, stage completion tracking, and evidence summary display. Created progress dashboard page (`/cando/progress/page.tsx`) showing lessons studied, stage completion, evidence summaries, and adaptive recommendations. Added API client (`cando-progress.ts`) for evidence tracking. Added comprehensive pytest tests for evidence tracking and recommendation service.
- ✅ **Include PreLessonKit in CanDo creation (per-level cache)**: Extended `/api/v1/cando/create` to generate and persist PreLessonKit during CanDo creation (default on, opt-out via `include_prelesson_kit=false`). Implemented per-level caching in Neo4j (`prelessonKitsJson` property) to handle different learner levels. Updated `start_lesson()` to reuse stored kits when available, regenerating and merging only when the requested level is missing. Added comprehensive pytest coverage for kit generation on create, opt-out behavior, failure fallback, and stored-kit reuse/merge.
- ✅ **Fix profile build save + goal extraction robustness**: Fixed `/profile/build` "Approve & Save" failures by removing duplicate `/api/v1/profile/complete` submissions (single source of truth for saving). Hardened backend AI JSON parsing for profile extraction to handle code-fenced/extra-text responses. Added lightweight unit tests for JSON parsing and verified via `scripts/check-pwy`.
- ✅ **Lexical Graph default center term**: Updated `/lexical/graph` to default to `言葉` instead of `日本` and extended Playwright-MCP `smoke.json` to assert the default value.
- ✅ **Lexical Graph Info 500 hardening**: Hardened `/api/v1/lexical/graph` and `/api/v1/lexical/node/{word}` against transient Neo4j failures by returning retryable 503s instead of 500s, filtered null-neighbor rows, added unit tests that mock Neo4j outages, and verified the UI via `check-pwy`.
- ✅ **Fix Home Status 500**: Fixed `/api/v1/home/status` returning 500 by removing an unconditional DB rollback in `check_profile_completion` that expired the authenticated user (triggering `sqlalchemy.exc.MissingGreenlet`). Also guarded optional `User.native_language` access so deployments where the `users` table lacks that column still return 200. Added regression tests.
- ✅ **Reopen Home Status 500 (missing `learning_paths`)**: Hardened `/api/v1/home/status` against deployments where the `learning_paths` table migration hasn't been applied yet (avoid 500s, best-effort self-heal) and fixed prompt formatting (`{start_endpoint}` → literal). Added a regression test.
- ✅ **Fix `/profile/build` missing `user_profiles` table in production**: Added a simple Postgres startup migration runner that applies `backend/migrations/versions/*.sql` once (tracked in `schema_migrations`) so persistent DB volumes receive schema updates. Added a self-healing fallback that creates `user_profiles` on demand if a deploy ever misses migrations, plus regression tests.
- ✅ **Grammar pattern cards UX + content refresh**: Improved grammar study page (`/grammar/study/[patternId]`) with consistent UI using design tokens instead of one-off gradients/colors. Extended AI overview schema with learner-focused fields (`formation`, `nuance`, `common_mistakes`) and improved the prompt for better explanations. Added romaji auto-prettification (`prettify_romaji_template`) to format textbook templates like `N(kotoba)gadekimasu(ka)` with proper spacing. Applied prettification to all grammar API responses. Added comprehensive pytest tests for romaji formatting and overview schema validation.
- ✅ **Grammar 4-stage learning loop + evidence dashboard**: Implemented explicit 4-stage learning pattern (Presentation → Comprehension → Production → Interaction) for grammar study. Added backend evidence tracking endpoints (`/api/v1/grammar/evidence/record`, `/api/v1/grammar/evidence/summary`) that store per-stage evidence in `conversation_interactions` table with rubric scores, error tags, and stage-specific metadata. Refactored grammar study UI into 4 explicit stages with new Production stage. Added evidence panel showing progress metrics and common errors. Created grammar progress overview page (`/grammar/progress`). Updated conversation practice to persist sessions/messages and record interaction evidence. Added comprehensive pytest tests for evidence recording and summary endpoints. Added migration for `metadata` JSONB column on `conversation_interactions`.
- **Script section + endpoints (Japanese scripts)**: Add new "Script" learning section for Japanese kana (Hiragana/Katakana) with practice modes (kana→romaji, romaji→kana, multiple-choice). Backend: `/api/v1/script/*` endpoints, static JSON dataset, progress tracking via `conversation_interactions`. Frontend: new Script nav dropdown, overview/practice/progress pages. Includes pytest coverage and README updates.

### 2025-12-31
- ✅ **Full E2E Registration Test Suite**: Added comprehensive browser-based E2E testing for user registration flow. Created `tests/mcp/scenarios/full_registration_e2e.json` MCP scenario for full registration -> profile building -> learning path flow (uses `nativeInputValueSetter` for React form compatibility). Added `frontend/tests/ui/registration.spec.ts` Playwright spec with tests for registration flow, form validation, login navigation, and profile building. Created helper script `scripts/check-registration-e2e` for running registration E2E tests. Updated `scripts/check-pwy` with `INCLUDE_REGISTRATION_E2E=1` environment variable option. Key insight: React controlled forms require `nativeInputValueSetter` pattern for programmatic input, not simple `dispatchEvent`.
- ✅ **Comprehensive E2E Test Suite + CI/CD**: Created 5 additional E2E scenarios (`home_status_e2e.json`, `login_e2e.json`, `lexical_graph_e2e.json`, `grammar_study_e2e.json`, `cando_lesson_e2e.json`) covering critical user flows. Set up GitHub Actions CI/CD workflows (`.github/workflows/e2e-tests.yml` for fast PR tests, `.github/workflows/e2e-tests-full.yml` for daily full suite). Created `scripts/run-e2e-tests.sh` test runner with timeout handling, health checks, and colored output. Added comprehensive debugging guide in `docs/E2E_TESTING.md` with troubleshooting, best practices, and scenario creation guide. All scenarios tested and passing.

### Discovered During Work
- Add a regression check (Playwright/MCP) that fails if dev-only Next.js endpoints are reachable in production.
- Add a server note: when using `network_mode: service:frontend`, recreating `frontend` requires recreating `cloudflared` too (otherwise Cloudflare Tunnel Error 1033 / 502).
- Browser MCP tools (cursor-ide-browser) don't reliably trigger React form state updates even with `slowly` option; prefer MCP Runner JSON scenarios with `nativeInputValueSetter` for React forms.


