#!/usr/bin/env bash
set -euo pipefail

# Deploy helper for the Hostinger + Cloudflare Tunnel server stack (Option A).
#
# Why this exists:
# - `cloudflared` uses `network_mode: service:frontend` (tunnel points to http://localhost:3000).
# - If `frontend` is recreated (common after rebuilds), `cloudflared` must be recreated too,
#   otherwise the public site can show Cloudflare Tunnel Error 1033 / 502.
#
# Usage:
#   ./scripts/deploy-server
#
# Notes:
# - Requires Docker/Compose on the server.
# - Runs from repo root.

COMPOSE_FILE_PATH="${COMPOSE_FILE_PATH:-docker-compose.server.yml}"

echo "[deploy-server] Using compose file: ${COMPOSE_FILE_PATH}"

echo "[deploy-server] Rebuilding/restarting backend + frontend..."
docker compose -f "${COMPOSE_FILE_PATH}" up -d --build backend frontend

echo "[deploy-server] Recreating cloudflared (required after frontend recreate)..."
docker compose -f "${COMPOSE_FILE_PATH}" up -d --force-recreate cloudflared

echo "[deploy-server] Done."


