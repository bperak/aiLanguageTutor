name: E2E Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      run_all_scenarios:
        description: 'Run all scenarios (including slow ones)'
        required: false
        default: 'false'
        type: boolean

jobs:
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_DB: ai_language_tutor
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: testpassword123
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      neo4j:
        image: neo4j:5.15-community
        env:
          NEO4J_AUTH: neo4j/testpassword123
          NEO4J_PLUGINS: '["apoc"]'
          NEO4J_dbms_security_procedures_unrestricted: apoc.*
        options: >-
          --health-cmd "cypher-shell -u neo4j -p testpassword123 'RETURN 1'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 7474:7474
          - 7687:7687

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create .env file
        run: |
          cat > .env << EOF
          DATABASE_URL=postgresql+asyncpg://postgres:testpassword123@postgres:5432/ai_language_tutor
          NEO4J_URI=bolt://neo4j:7687
          NEO4J_USERNAME=neo4j
          NEO4J_PASSWORD=testpassword123
          OPENAI_API_KEY=${OPENAI_API_KEY}
          GEMINI_API_KEY=${GEMINI_API_KEY}
          GOOGLE_CLOUD_PROJECT_ID=${GOOGLE_CLOUD_PROJECT_ID}
          JWT_SECRET_KEY=$(openssl rand -hex 32)
          JWT_ALGORITHM=HS256
          ENVIRONMENT=test
          DEBUG=false
          PGVECTOR_ENABLED=true
          EMBEDDING_DIMENSIONS=1536
          NEO4J_VECTOR_ENABLED=true
          NEXT_PUBLIC_API_BASE_URL=http://backend:8000
          NEXT_PUBLIC_APP_NAME=AI Language Tutor
          EOF
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GOOGLE_CLOUD_PROJECT_ID: ${{ secrets.GOOGLE_CLOUD_PROJECT_ID }}

      - name: Build Docker images
        run: |
          docker compose -f docker-compose.server.yml build backend frontend mcp-runner

      - name: Start services
        run: |
          docker compose -f docker-compose.server.yml up -d postgres neo4j backend frontend mcp-runner

      - name: Wait for services to be healthy
        run: |
          echo "Waiting for services to be healthy..."
          timeout 180 bash -c 'until docker compose -f docker-compose.server.yml ps backend | grep -q "healthy" && docker compose -f docker-compose.server.yml ps frontend | grep -q "healthy"; do sleep 2; done'
          echo "Services are healthy!"

      - name: Run E2E tests
        run: |
          if [ "${{ github.event.inputs.run_all_scenarios }}" == "true" ]; then
            echo "Running all scenarios including slow ones..."
            ./scripts/run-e2e-tests.sh
          else
            echo "Running fast scenarios only..."
            ./scripts/run-e2e-tests.sh \
              /work/scenarios/smoke.json \
              /work/scenarios/no_dev_next_endpoints.json \
              /work/scenarios/home_status_e2e.json \
              /work/scenarios/login_e2e.json \
              /work/scenarios/lexical_graph_e2e.json \
              /work/scenarios/prelesson_kit_flow.json
          fi
        continue-on-error: false

      - name: Show service logs on failure
        if: failure()
        run: |
          echo "=== Backend Logs ==="
          docker compose -f docker-compose.server.yml logs backend --tail=100 || true
          echo ""
          echo "=== Frontend Logs ==="
          docker compose -f docker-compose.server.yml logs frontend --tail=100 || true
          echo ""
          echo "=== MCP Runner Logs ==="
          docker compose -f docker-compose.server.yml logs mcp-runner --tail=100 || true

      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker-compose.server.yml down -v
